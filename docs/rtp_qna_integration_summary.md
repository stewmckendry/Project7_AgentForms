
# ğŸ§  Return-to-Play Q&A Module â€“ Integration Summary

## ğŸ”¹ Overview
This implementation enables natural-language Q&A around **concussion return-to-play guidance**, grounded in your official protocol (`return_to_play.yaml`) and the playerâ€™s current recovery status (`assessment_bundle`).

---

## ğŸ“ 1. `rtp_qa.py`
Contains the two main entry points for generating personalized RTP advice.

### âœ… `generate_rtp_response_rule_based(activity_name, assessment_bundle, rtp_reference) â†’ dict`
**Purpose**:  
Matches a specific activity name (e.g., `"go for a walk"`) against protocol stages. Uses current player status to determine if the activity is allowed.

**Inputs**:
- `activity_name`: string name of the activity
- `assessment_bundle`: final responses + thoughts
- `rtp_reference`: loaded list from `return_to_play.yaml`

**Returns**:
```python
{
  "activity_match": True/False,
  "allowed": "yes" | "no" | "uncertain",
  "stage_required": "Stage 3: Sport-specific drills",
  "reason": "User is still symptomatic...",
  "recommendations": "Based on the protocol, they should wait until...",
  "citations": ["Parachute Canada (2019)"]
}
```

---

### âœ… `generate_rtp_response_llm(user_question, assessment_bundle, rtp_reference) â†’ dict`
**Purpose**:  
Answers natural-language questions (e.g., â€œCan we skate yet?â€, â€œWhatâ€™s next?â€) using the current assessment and RTP protocol as context. No hardcoded activity matching required.

**Inputs**:
- `user_question`: plain text (e.g., â€œCan they do gym class?â€)
- `assessment_bundle`: structured status and history
- `rtp_reference`: full return-to-play stages

**Returns**:  
Same output format as above, but generated by an LLM prompt.

---

## ğŸ“ 2. `rtp_utils.py`
Supports the Q&A system with helper functions for summarizing, parsing, and stage logic.

### âœ… `find_current_stage(responses) â†’ str`
**Purpose**:  
Infers the userâ€™s current RTP stage using structured symptom and clearance responses.

**Returns**:  
e.g., `"stage_1"`, `"stage_3"`, or `"stage_6"` (cleared)

---

### âœ… `summarize_bundle(assessment_bundle) â†’ str`
**Purpose**:  
Converts structured responses into a human-readable summary string for use in LLM prompts.

---

### âœ… `summarize_rtp_protocol(rtp_reference) â†’ str`
**Purpose**:  
Formats the full RTP protocol (stage names, descriptions, allowed activities) into readable markdown-like text for LLM grounding.

---

### âœ… `parse_llm_rtp_response(response_text) â†’ dict`
**Purpose**:  
Takes markdown output from the LLM and converts it into a structured dictionary with keys like `allowed`, `reason`, `stage_required`, etc.  
(Current version is a placeholder â€“ can be upgraded with regex or JSON logic.)

---

## âœ… Summary for ChatGPT Integration

| Component | Purpose |
|----------|---------|
| `generate_rtp_response_rule_based()` | Matches exact activity â†’ stage â†’ allowed? |
| `generate_rtp_response_llm()` | Answers natural questions using LLM and current status |
| `find_current_stage()` | Inference: What RTP stage is the user in? |
| `summarize_bundle()` | Summarizes structured inputs for LLM |
| `summarize_rtp_protocol()` | Formats RTP YAML into readable content |
| `parse_llm_rtp_response()` | Converts LLM answers into app-usable fields |
